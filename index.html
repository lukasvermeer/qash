<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <script src="vue/vue.js"></script>

    <script src="jquery/jquery-3.3.1.js"></script>
    <script src="jquery-csv/jquery.csv.js"></script>

    <script src="bootstrap-4/js/bootstrap.js"></script>
    <link rel="stylesheet" href="bootstrap-4/css/bootstrap.min.css">

    <link href="c3-0.6.7/c3.css" rel="stylesheet">
    <script src="d3/d3.min.js"></script>
    <script src="c3-0.6.7/c3.min.js"></script>

    <link rel="stylesheet" href="qash.css">
  </head>

  <body>
    <div id="app" class="container">
      <div class="row">
        <div class="col">
          <h1>Qash <span class="text-muted">Personal Finance Analytics</span> <span class="badge badge-warning">PRE-ALPHA</span></h1>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h4>Source files in local storage
          <button class="btn btn-sm btn-outline-danger" v-if="hasStoredState" @click.prevent="clear()">
            clear storage
          </span></h4>
        </div>
        <ul class="list-group">
          <li class="text-muted list-group-item d-flex justify-content-between align-items-center" v-if="!hasStoredState">
            No data in local storage.
          </li>
          <li class="list-group-item d-flex justify-content-between align-items-center" v-for="(file, index) in persistentStorage.sourceFiles">
              {{file.name}} <span class="text-muted">({{file.data.length}} transactions)</span>
              <span class="badge badge-error badge-pill">
                <a @click.prevent="deleteEntry(index)" href="#">delete</a>
              </span>
          </li>
        </ul>
        <div class="card-footer">
          <form>
            <div class="dropbox">
              <input type="file" multiple :disabled="ui.input.sourceFileAddDisabled" @change="filesChange($event.target.files)" accept=".csv" class="input-file">
              <p>Drag ING Bank .csv file(s) here to begin<br> or click to browse</p>
            </div>
          </form>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <div id="chart"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h4>Transactions</h4>
          <table class="table">
            <thead>
              <tr>
                <th scope="col">Date</th>
                <th scope="col">From</th>
                <th scope="col">To</th>
                <th scope="col">Description</th>
                <th scope="col">Amount</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="(t, index) in allTransactions">
                <th scope="row">{{t.Datum}}</th>
                <td>{{t['Rekening']}}</td>
                <td>{{t['Naam / Omschrijving']}}<br />{{t['Tegenrekening']}}</td>
                <td><span class="badge badge-pill badge-secondary">{{t['MutatieSoort']}}</span><br />{{t['Mededelingen']}}</td>
                <td><span class="badge badge-pill" v-bind:class="[t['Af Bij']=='Af'?'badge-danger':'badge-success']">{{t['Af Bij']=='Af' ? '-' : '+'}}{{t['Bedrag (EUR)']}}</span></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      var app = new Vue({
      el: '#app',
      data: {
        persistentStorage: {
          sourceFiles: []
        },
        hasStoredState: localStorage.getItem('qashStorage') ? true : false,
        ui: {
          input: {
            sourceFileAddDisabled: false,
          },
        },
      },
      mounted: function() {
        if (this.hasStoredState) { this.load(); }
      },
      methods: {
        // STORAGE METHODS
        load: function() {
          if (localStorage.getItem('qashStorage')) {
            this.persistentStorage = JSON.parse(localStorage.getItem('qashStorage'));
          }
        },
        clear: function() {
          this.persistentStorage = { sourceFiles: [] };
        },
        deleteEntry: function(i) {
          this.persistentStorage.sourceFiles.splice(i,1);
        },
        addEntry: function(e) {
          this.persistentStorage.sourceFiles.push(e);
        },
        // END STORAGE METHODS

        // FILE READ METHODS
        filesChange: function(fileList) {
          if (!fileList.length) return;
          Array
            .from(Array(fileList.length).keys())
            .map(x => { this.readSingleFile(fileList[x]); });
        },
        readSingleFile: function(f) {
          if (!f) { return; }
          const reader = new FileReader();
          reader.onload = function(e) {
            var entry = {
              name: f.name, 
              lastModified: f.lastModified, 
              data: $.csv.toObjects(e.target.result)
            };
            app.addEntry(entry);
          };
          reader.readAsText(f);
        },
        // END FILE READ METHODS
      },
      computed: {
        allTransactions: function() {
          // TODO deduplication, etc.
          return [].concat.apply([], this.persistentStorage.sourceFiles.map(x => x.data));
        },
      },
      watch: {
        persistentStorage: {
          deep: true,
          handler: function(f) {
            if (f.sourceFiles.length > 0) {
              localStorage.setItem('qashStorage', JSON.stringify(f)) == '';
            }
            else {
              localStorage.removeItem('qashStorage');
            }
            this.hasStoredState = localStorage.getItem('qashStorage') ? true : false;
          }
        }
      }
      })
    </script>
  </body>
</html>
